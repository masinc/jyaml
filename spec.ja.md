# JYAML 仕様 バージョン 0.2

## 概要

JYAML(JSON-YAML Adaptive Markup Language)は、JSONの上位互換を持ち、YAMLの下位互換を持つデータフォーマットです。

データはJSONが表現できるもののみJYAMLでも表現することが可能です。

言い換えると JSON は全て JYAML データとして適正であり、JYAMLデータ は全て YAML データとして適正となります。

JYAMLは JSON フォーマットに YAML のブロックスタイルや複数行文字列スタイル、コメントなどが利用できるデータフォーマットです。

## JYAMLの利点と目的

JYAML (JSON-YAML Adaptive Markup Language) は、JSON と YAML の長所を組み合わせたデータフォーマットで、両者の利便性と柔軟性を兼ね備えています。JYAML の主な利点は以下の通りです。

- JSON と YAML の両方に精通している者にとって、学習コストが低いです。
- JSON の構造のシンプルさと維持しつつ、YAML の可読性を提供したフォーマットです。
- `#` で単一行のコメントを記述することができます。
- JSON と YAML の両方の中間データ構造をサポートするため、データ交換の際に両フォーマット間で容易に変換することができます。
- JSON と上位互換性があるため、JSON データは JYAML データとしても適正であり、スムーズに移行することができます。
- YAML と下位互換性があるため、JYAML データは YAMLデータとして適正です。YAML を利用するシステムやアプリケーションにて、 YAML固有の機能を活用されていない場合、そのままJYAML を利用することができます。

## バージョンについて

JYAMLのバージョンは 0.x は正式リリース前のバージョンとなります。

## 拡張子

JYAMLでは通常、次の拡張子のいずれかを利用します。

- jyml
- jyaml

また、YAMLとの相互利用のために、次の拡張子を利用することができます。

- j.yml
- j.yaml

## エンコーディング

JYAMLドキュメントは、BOM（Byte Order Mark）なしのUTF-8でエンコードされている必要があります。

- ファイル先頭のBOM（0xEF 0xBB 0xBF）は許可されません
- 無効なUTF-8シーケンスはエラーとして拒否されなければなりません
- パーサーは他のエンコーディングのファイルを解釈しようとしてはいけません

エラーの例：
- BOMで始まるファイル
- 不完全なマルチバイトシーケンス
- 無効な継続バイト
- オーバーロングエンコーディング

## ドキュメント構造

JYAMLドキュメントは、ルートレベルで任意の有効なJYAML値を持つことができます：
- Object
- Array
- String
- Number
- Boolean
- Null

これは、ルートレベルで任意のJSON値を許可するモダンなJSON仕様（RFC 7159以降）に従っています。

有効なJYAMLドキュメントの例：

```
# ルートがObject
"name": "John"
"age": 30

# ルートがArray
- 1
- 2
- 3

# ルートがString
"Hello, World!"

# ルートがNumber
42

# ルートがBoolean
true

# ルートがNull
null
```

注意：JYAMLはルートレベルで任意の値を許可しますが、一部の古いJSONパーサーはオブジェクトまたは配列のみを受け入れる場合があります。レガシーシステムとの最大限の互換性を確保するには、ルートレベルでオブジェクトまたは配列を使用することを検討してください。

## スタイル混在のルール

JYAMLでは、以下のルールに従ってブロックスタイルとフロースタイルを混在させることができます：

1. **ブロックスタイルはフロースタイルを含むことができる** - ブロック構造内でフローコレクションや値を使用可能
2. **フロースタイルはブロックスタイルを含むことができない** - フローコンテキスト（括弧や波括弧内）では、フロー構文のみ許可

例：

```
# 有効：ブロック内にフロー
"config":
  "servers": ["web1", "web2", "web3"]
  "database": {"host": "localhost", "port": 5432}
  "features":
    - "feature1"
    - ["sub1", "sub2"]

# 無効：フロー内にブロック
{
  "servers":
    - "web1"    # エラー！フローコンテキスト内でブロックスタイル
    - "web2"
}

# 無効：混在構文
{"a": 1, "b": - 2 - 3}  # エラー！フローオブジェクト内でブロックスタイル配列

# 有効：適切なフロー構文
{"a": 1, "b": [2, 3]}
```

## インデントルール

Object 型、Array 型のブロックスタイルや String型の複数行文字列を扱う場合、インデントは次のように扱われます：

- インデントにはスペースを使用（タブは許可されません）
- 同じネストレベルでのインデントの数は一貫している必要があります
- 子要素は親要素よりも多くインデントする必要があります
- 推奨：レベルごとに2スペース（ただし、一貫した任意の数が有効）
- フロースタイルでは、文字列内を除いてホワイトスペースは無視されます
- Object 型のキーと値の間のコロンの後には、1つ以上のホワイトスペースが必要です

## コメント

JYAMLは2種類の単一行コメントをサポートします：
- `#` - YAMLスタイルのコメント
- `//` - Cスタイルのコメント

コメントは行頭または値の後に配置できます。コメントマーカーから行末までがコメントとして扱われ、JYAMLデータの解析には影響しません。

例：

```
# YAMLスタイルのコメント
"name": "John"  # インラインコメント

// Cスタイルのコメント
"age": 30  // 別のインラインコメント

// 同一ファイル内で両方のスタイルを使用可能
"config":
  "timeout": 30  # 秒
  "retries": 3   // 最大試行回数
```

注意：複数行コメント（`/* */`）はシンプルさのためJYAMLではサポートされません。

### コメント解析ルール

コメントは文字列コンテキスト外でのみ認識されます：

- 引用符で囲まれた文字列内では、`#`と`//`はリテラル文字として扱われます
- コメントは`#`または`//`が文字列外に現れた場合のみ開始されます
- 複数行文字列内では、コメントマーカーは内容として保持されます

例：

```
# 有効 - 文字列外のコメント
"url": "http://example.com"  # これはコメント
"pattern": "^#\\d+"  // これもコメント

# 文字列内容 - コメントではない
"url": "http://example.com"     # URL内の//はコメントではない
"message": "Use # for comments"  # この#は文字列の一部
'path': 'C:\\dir // not comment' # この//は文字列の一部

# 複数行文字列はコメントマーカーを保持
description: |
  # これはコメントではない
  // これもコメントではない
  http://example.com
```

## データ型

JYAML では次のデータ型が存在します。

- String
- Number
- Boolean
- Array
- Object
- Null

これらのデータ型はJSONと同様となります。

## String 型

単一行の String 型の値はシングルクォーテーションまたは、ダブルクォーテーションで囲うことで表現することが可能です。

例:

```
"aaa"
'aaa'
```

YAML と違い、クォーテーションなしで表現することはできません。

### 文字列の制限

JYAMLの文字列はJSONのルールに従います：

- 明示的な長さ制限なし（実装依存）
- 制御文字（U+0000からU+001F）はエスケープが必要
- 制御文字の有効なエスケープ：
  - `\b`、`\f`、`\n`、`\r`、`\t` - 一般的な制御文字
  - `\uXXXX` - その他の制御文字を含む任意のUnicode文字

例：
```
# 有効 - エスケープされた制御文字
"line1\nline2"        # 改行
"name\tvalue"         # タブ
"text\u0000data"      # NUL文字

# 無効 - エスケープされていない制御文字
"line1
line2"                # リテラルな改行は不可
```


### エスケープ文字

JYAMLでは、ダブルクォート文字列とシングルクォート文字列で異なるエスケープルールがあります。

#### ダブルクォート文字列

ダブルクォート文字列はJSONのエスケープルールに従います。以下の表のすべてのエスケープシーケンスが有効です：

| エスケープ指定 | 結果            |
| -------------- | --------------- |
| `\"`           | `"`             |
| `\'`           | `'`             |
| `\\`           | `\`             |
| `\/`           | `/`             |
| `\b`           | Back Space      |
| `\f`           | Form Feed       |
| `\n`           | Line Feed       |
| `\r`           | Carriage Return |
| `\t`           | Tab             |
| `\uXXXX`       | Unicode         |

`\uXXXX` は `XXXX` に16進数で4桁の値を指定することで任意の Unicode 文字を表現することができます。

#### シングルクォート文字列

シングルクォート文字列は限定的なエスケープサポートを持ちます：
- `\'` - シングルクォート
- `\\` - バックスラッシュ
- その他のエスケープシーケンスはすべて文字通りに扱われます（解釈されません）

例:

```
# ダブルクォート - 完全なエスケープ
"Hello\nWorld"        # Hello<改行>World
"Path: \"C:\\temp\""  # Path: "C:\temp"
"Unicode: \u00A9"     # Unicode: ©
"It's fine"          # It's fine

# シングルクォート - 限定的なエスケープ
'Hello\nWorld'        # Hello\nWorld (文字通りの\n)
'can\'t stop'         # can't stop
'Path: C:\\temp'      # Path: C:\temp
'Unicode: \u00A9'     # Unicode: \u00A9 (文字通り)
```

注意：これはYAMLとは異なります。YAMLではシングルクォートを2つ重ねてエスケープします（`''`）。JYAMLはJSONおよび一般的なプログラミング言語との一貫性のためにバックスラッシュエスケープを使用します。


### 複数行文字列

複数行文字列は、オプションのチョンプ指標付きで2つのスタイルをサポートします：

- `|`（リテラル）- 改行を保持
- `>`（折り畳み）- 改行をスペースに変換

チョンプ指標（オプション）：
- `|-` または `>-` - 末尾の改行を削除
- `|` または `>` - 末尾に改行1つ（デフォルト）

例：

```
# リテラルスタイル
key1: |
  Line 1
  Line 2
# 結果: "Line 1\nLine 2\n"

key2: |-
  Line 1
  Line 2
# 結果: "Line 1\nLine 2"

# 折り畳みスタイル
key3: >
  This is a
  single line.
# 結果: "This is a single line.\n"

key4: >-
  This is a
  single line.
# 結果: "This is a single line."
```

注意：`|+`と`>+`（keep）指標はシンプルさのためJYAMLではサポートされません。先頭のインデントは最初のコンテンツ行に基づいて自動的に削除されます。

## Number 型

Number 型は 10 進数で記述された先頭に 0 がない値となります。
`.` で小数点を表し、小数点以下の表記することができます。
先頭に `+` または、 `-` 記号を付与することができます。
`e` または `E` を利用することで指数表記をすることができます。

JYAMLの数値はJSONと同じルールに従います：
- 明示的な範囲制限なし（実装依存）
- `Infinity`、`-Infinity`、`NaN` は許可されません
- 科学的記数法をサポート（例：`1.23e10`）

例:

```
1
+1
-1
1.23
1e2
1e-2
```

注意：最大限の相互運用性のため、以下を考慮してください：
- 整数は ±2^53-1 以内に留める（JavaScriptの安全な整数範囲）
- 非常に大きいまたは小さい数値は、一部の実装で精度が失われる可能性があります

## Boolean 型

Boolean 型は `true` または、 `false` リテラルで値が表現できる型です。

YAML の `on`, `off`, `yes`, `no` リテラルなどは JYAMLでは不正な値です。

## Array 型

Array 型は 0 個以上の値を持つ型です。

Array 型はブロックスタイルまたは、フロースタイルで記述することができます。

ブロックスタイルは値ごとに改行してインデントを付けることで表現することができます。
フロースタイルは値の一覧を角括弧で囲い(`[`, `]`)値をカンマ(`,`)区切りで表現することができます。

ブロックスタイル例:

```
- 1
- 2
- 3
```

フロースタイル例:

```
[ 1, 2, 3 ]
```

オブジェクトを含む配列の例:

```
# ブロックスタイル
- "name": "Alice"
  "age": 30
- "name": "Bob"
  "age": 25

# ブロックスタイルのオブジェクトを含むフロースタイル
[
  {
    "name": "Alice",
    "age": 30
  },
  {
    "name": "Bob",
    "age": 25
  }
]
```


## Object 型

Object 型は 0 個以上のキーと値のペアを持つ型です。

キーと値はコロン(`:`)で区切り、ペアとして表現することができます。

キーは String 型のみ利用することができ、複数行文字列表現は利用する事ができず、シングルクォーテーションまたは、ダブルクォーテーションを利用した単一行文字列表現にする必要があります。

Object 型はブロックスタイルまたは、フロースタイルで記述することができます。

ブロックスタイルは、ペアを改行してインデントを付けることで表現することができます。
フロースタイルは、ペアを波括弧で囲い(`{`, `}`)キーと値をカンマ(`,`)区切りで表現することができます。

ブロックスタイル例:

```
"a": 1
"b": 2
'c': 3
```

フロースタイル例:

```
{ "a": 1, "b": 2, "c": 3 }
```

配列を含むオブジェクトの例:

```
# ブロックスタイル
"users":
  - "Alice"
  - "Bob"
"scores":
  - 95
  - 87

# 混合スタイル
{
  "users": ["Alice", "Bob"],
  "scores": [95, 87]
}
```

深くネストした構造の例:

```
# 複雑なネスト構造
"company":
  "name": "TechCorp"
  "departments":
    - "name": "Engineering"
      "employees":
        - "name": "Alice"
          "skills":
            - "Python"
            - "JavaScript"
        - "name": "Bob"
          "skills":
            - "Java"
            - "Go"
    - "name": "Sales"
      "employees":
        - "name": "Charlie"
          "regions":
            - "North"
            - "South"

# ブロックスタイルとフロースタイルの混在
"config":
  "servers": ["web1", "web2"]
  "database":
    "host": "localhost"
    "port": 5432
    "options": {"ssl": true, "pool": 10}
```

## Null型

Null値は小文字の `null` リテラル（大文字小文字を区別）で表現されます。

例:

```
"key": null
```

YAMLの `~` 記法や空の値はJYAMLでは無効です。

## エラーケース

JYAMLパーサーは以下のエラー条件を検出し報告する必要があります：

### 構文エラー
- 引用符の不一致：`"name': "value"`
- 閉じられていない文字列：`"name": "value`
- 閉じられていないコレクション：`[1, 2, 3`
- インデントでのタブ文字
- ブロック構造での不一致なインデント

### 型エラー
- 無効な数値形式：`01234`、`1.2.3`、`123abc`
- 無効なブール値：`yes`、`no`、`on`、`off`（`true`/`false`のみ使用）
- 無効なnull値：`~`、`Null`、`NULL`（`null`のみ使用）
- 文字列でないキー：`123: "value"`、`null: "value"`

### 構造エラー
- フローコンテキスト内のブロック構文：`{"items": - 1}`
- シングルクォート内の無効なエスケープ（`\'`と`\\`を除く）
- 複数行文字列でのインデント不足
- 同一オブジェクト内のキー重複

### 無効なJYAMLの例

```
# 無効：混在インデント
"users":
  - "alice"
   - "bob"      # エラー：不一致なインデント

# 無効：フロー内のブロック
{"config": "timeout": 30}  # エラー："config"の後のコロンが不足

# 無効：間違ったブール値
"active": yes   # エラー：true/falseのみ使用

# 無効：先頭ゼロ
"count": 0123   # エラー：先頭ゼロは禁止

# 無効：タブインデント
"name":	"value"  # エラー：タブは禁止

# 無効：文字列でないキー
123: "value"    # エラー：キーは文字列必須

# 無効：閉じられていない文字列
"message": "Hello world  # エラー：閉じ引用符が不足
```

## ファイル構造

JYAMLファイルは正確に1つのJYAML値を含みます：

- 複数ドキュメント（YAMLの`---`セパレーター）はサポートされません
- 空ファイルは無効 - 値が必要です
- ファイル末尾の改行はオプション
- ルート値の後にはコメント以外のコンテンツを含めてはいけません

例：

```
# 有効な単一ドキュメント
"value": 42

# 無効 - 空ファイル
(empty)

# 無効 - 複数ドキュメント
"doc1": 1
---
"doc2": 2
```

## 互換性

- **JSON → JYAML**: すべての有効なJSONは有効なJYAML（完全互換）
- **JYAML → YAML**: ほとんどのJYAMLは有効なYAML、1つの例外あり：
  - `\'`エスケープ構文を使用するシングルクォート文字列（YAMLは`''`でエスケープ）
  - 完全なYAML互換性のため、エスケープシーケンスが必要な場合はダブルクォート文字列を使用

例：
```
# JYAMLのシングルクォートエスケープ（YAML非互換）
'can\'t stop'

# YAML互換の代替案
"can't stop"    # ダブルクォートを使用
'can''t stop'   # YAMLスタイルのエスケープ（有効なJYAMLではない）
```
